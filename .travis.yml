language: ruby
cache:
  bundler: true
  pip: true
  directories:
  - _site
  - _amp
rvm:
  - 2.4
python:
  - "3.6"
jdk:
  - openjdk8
install:
- pip install --upgrade --user awscli
- pip install --user docutils==0.14
- bundle install
before_script:
- aws s3 sync s3://meta-dxfoto-ru _data --quiet --exclude "logs/*"
script:
- bundle exec jekyll build -I
- AMP=yes bundle exec jekyll build -I --config _config-amp.yml
branches:
  only:
  - deploy-aerobatic
after_success:
# - bundle exec s3_website push
  - bundle exec s3_website install
  - java -cp $(bundle show s3_website)/*.jar s3.website.Push
  - mv -f _amp/index-amp.html _amp/index.html
  - mv -f _amp/error-amp.html _amp/error.html
# - AMP=yes bundle exec s3_website push
  - AMP=yes java -cp $(bundle show s3_website)/*.jar s3.website.Push
  - sh purge.sh
#  - rm -f .gitignore && touch .gitignore
#  - git config --global user.name "Travis CI"
#  - git config --global user.email "nobody@nowhere.org"
#  - TRAVIS_COMMIT=$(git log --format=%B -n 1)
#  - git add .
#  - git commit -m "$TRAVIS_COMMIT"
#deploy:
#  provider: s3
#  bucket: www.dxfoto.ru
#  local-dir: _site
#  acl: public_read
#  region: eu-west-1
#  on:
#    repo: at8eqeq3/dxfoto.ru
#    branch: deploy-aerobatic
